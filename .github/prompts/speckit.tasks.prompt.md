---
description: 基于现有设计产物生成可执行且按依赖排序的 tasks.md
---

## 用户输入

```text
$ARGUMENTS
```

若用户输入不为空，你**必须**在继续前先行考虑。

## 执行大纲

1. **初始化**：在仓库根目录运行 `.specify/scripts/powershell/check-prerequisites.ps1 -Json`，解析输出中的 FEATURE_DIR 与 AVAILABLE_DOCS 列表。所有路径必须为绝对路径。若参数含单引号（如 "I'm Groot"），需使用转义 `'I'\''m Groot'`，或尽量改用双引号（"I'm Groot"）。

2. **加载设计文档**：从 FEATURE_DIR 读取：
   - **必读**：`plan.md`（技术栈、库、结构）、`spec.md`（带优先级的用户故事）。
   - **可选**：`data-model.md`（实体）、`contracts/`（API 接口）、`research.md`（决策）、`quickstart.md`（测试场景）。
   - 说明：并非所有项目都有全部文档，需基于现有内容生成任务。

3. **执行任务生成流程**：
   - 读取 `plan.md`，提取技术栈、依赖库、项目结构。
   - 读取 `spec.md`，提取用户故事及其优先级（P1、P2、P3 等）。
   - 若存在 `data-model.md`：提取实体并映射到用户故事。
   - 若存在 `contracts/`：将接口映射到用户故事。
   - 若存在 `research.md`：提炼决策以支撑初始化任务。
   - 按用户故事组织任务（参见后文“任务生成规则”）。
   - 生成用户故事完成顺序的依赖图。
   - 为每个用户故事列出并行执行示例。
   - 校验任务完整性（每个用户故事都具备独立测试所需的全部任务）。

4. **生成 tasks.md**：以 `.specify/templates/tasks-template.md` 为结构，填入：
   - 来自 `plan.md` 的正确功能名称。
   - 第 1 阶段：Setup 任务（项目初始化）。
   - 第 2 阶段：基础任务（所有用户故事的前置条件）。
   - 第 3 阶段及之后：每个用户故事一个阶段（按 `spec.md` 优先级排序）。
   - 每个阶段需包含：故事目标、独立测试准则、（若要求）测试任务、实现任务。
   - 最终阶段：打磨与跨领域关注点。
   - 所有任务必须遵守严格的核对单格式（见后文“任务生成规则”）。
   - 为每个任务提供明确的文件路径。
   - 添加“依赖”章节展示故事完成顺序。
   - 为每个故事提供并行执行示例。
   - 增加“实现策略”部分（先 MVP，逐步交付）。

5. **汇报**：输出生成的 `tasks.md` 路径及摘要：
   - 总任务数量；
   - 各用户故事对应的任务数量；
   - 已发现的并行机会；
   - 每个故事的独立测试准则；
   - 推荐的 MVP 范围（通常仅包含用户故事 1）；
   - 格式验证：确认所有任务均符合核对单格式（复选框、ID、标签、文件路径）。

任务生成上下文：$ARGUMENTS

`tasks.md` 应可立即执行——每个任务都要具体到让 LLM 无需额外上下文即可完成。

## 任务生成规则

**关键要求**：任务必须按用户故事组织，以便独立实施与测试。

**测试为可选**：仅在功能规格明确要求或用户请求 TDD 时才生成测试任务。

### 核对单格式（必选）

每个任务**必须**严格遵守以下格式：

```text
- [ ] [TaskID] [P?] [Story?] Description with file path
```

**格式组成**：

1. **复选框**：始终以 `- [ ]` 开头。
2. **任务 ID**：按执行顺序递增（T001、T002、T003…）。
3. **[P] 标记**：仅在任务可并行（改动不同文件且无未完成依赖）时添加。
4. **[Story] 标签**：仅用户故事阶段任务必须添加。
   - 格式：`[US1]`、`[US2]`、`[US3]` 等（映射 `spec.md` 中的故事）。
   - Setup 阶段：不添加故事标签。
   - Foundational 阶段：不添加故事标签。
   - 用户故事阶段：必须包含故事标签。
   - Polish 阶段：不添加故事标签。
5. **描述**：清晰说明操作并写明具体文件路径。

**示例**：

- ✅ 正确：`- [ ] T001 Create project structure per implementation plan`
- ✅ 正确：`- [ ] T005 [P] Implement authentication middleware in src/middleware/auth.py`
- ✅ 正确：`- [ ] T012 [P] [US1] Create User model in src/models/user.py`
- ✅ 正确：`- [ ] T014 [US1] Implement UserService in src/services/user_service.py`
- ❌ 错误：`- [ ] Create User model`（缺少 ID 与故事标签）。
- ❌ 错误：`T001 [US1] Create model`（缺少复选框）。
- ❌ 错误：`- [ ] [US1] Create User model`（缺少任务 ID）。
- ❌ 错误：`- [ ] T001 [US1] Create model`（缺少文件路径）。

### 任务组织

1. **来源于用户故事（spec.md）** —— 主要组织方式：
   - 每个用户故事（P1、P2、P3…）单独成阶段。
   - 将相关组成部分映射到对应故事：
     - 该故事所需的模型；
     - 该故事所需的服务；
     - 该故事涉及的端点/界面；
     - 若要求测试：该故事的测试任务。
   - 标注故事之间的依赖（大多数故事应保持独立）。

2. **来源于契约**：
   - 将每个契约/端点映射到其服务的用户故事。
   - 若要求测试：在该故事阶段实现前添加契约测试任务 [P]。

3. **来源于数据模型**：
   - 将每个实体指派给需要它的用户故事。
   - 实体若服务多个故事：放在最早涉及该实体的故事或 Setup 阶段。
   - 实体关系 → 在相应故事阶段安排服务层任务。

4. **来源于初始化/基础设施**：
   - 共享基础设施 → 放入 Setup 阶段（阶段 1）。
   - 基础/阻塞任务 → 放入 Foundational 阶段（阶段 2）。
   - 故事专属初始化 → 安排在该故事所在阶段。

### 阶段结构

- **阶段 1**：Setup（项目初始化）。
- **阶段 2**：Foundational（阻塞性的前置工作，必须先于用户故事完成）。
- **阶段 3 及之后**：按优先级排列的用户故事（P1、P2、P3…）。
   - 每个故事内的顺序：测试（若要求）→ 模型 → 服务 → 端点 → 集成。
   - 每个阶段都应产出可独立测试的增量。
- **最终阶段**：Polish & Cross-Cutting Concerns（打磨与跨领域事项）。
