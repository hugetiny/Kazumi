---
description: 通过提出最多 5 个高针对性的澄清问题，识别当前功能规格中描述不足的部分，并将答案写回规格文档。
---

## 用户输入

```text
$ARGUMENTS
```

若用户输入不为空，你**必须**在继续前先行考虑。

## 流程概览

目标：识别并消除当前功能规格中的歧义或缺失决策点，并将澄清结果直接记录到规格文件。

说明：此澄清流程应在调用 `/speckit.plan` 之前执行并完成。若用户明确表示跳过澄清（如探索性 Spike），可继续，但必须提醒后续返工风险会增加。

执行步骤：

1. 在仓库根目录运行一次 `.specify/scripts/powershell/check-prerequisites.ps1 -Json -PathsOnly`（即同时启用 `--json --paths-only` / `-Json -PathsOnly` 模式），解析最小 JSON 字段：
   - `FEATURE_DIR`
   - `FEATURE_SPEC`
   - （可选）记录 `IMPL_PLAN`、`TASKS` 以备后续流程使用。
   - 若 JSON 解析失败，终止并提醒用户重新运行 `/speckit.specify` 或检查功能分支环境。
   - 若参数中包含单引号（如 "I'm Groot"），请使用转义写法 'I'\''m Groot'，或尽量改用双引号 "I'm Groot"。

2. 加载当前规格文件，并按照如下分类进行结构化的歧义与覆盖扫描。每个类别标记状态：Clear / Partial / Missing。生成内部覆盖图用于排序（除非完全不提问，否则不要输出原始覆盖图）。

   功能范围与行为：
   - 核心用户目标与成功标准
   - 明确的非范围声明
   - 用户角色 / 角色差异

   领域与数据模型：
   - 实体、属性、关系
   - 标识与唯一性规则
   - 生命周期 / 状态转换
   - 数据量 / 规模假设

   交互与 UX 流程：
   - 关键用户旅程 / 顺序
   - 错误 / 空态 / 加载状态
   - 可访问性或本地化说明

   非功能质量属性：
   - 性能（延迟、吞吐目标）
   - 可扩展性（水平/垂直、上限）
   - 可靠性与可用性（运行时间、恢复期望）
   - 可观测性（日志、指标、链路追踪信号）
   - 安全与隐私（认证/授权、数据保护、威胁假设）
   - 合规 / 监管约束（如有）

   集成与外部依赖：
   - 外部服务 / API 及其失败模式
   - 数据导入/导出格式
   - 协议 / 版本假设

   边界情况与故障处理：
   - 负面场景
   - 限流 / 节流
   - 冲突解决（如并发编辑）

   约束与权衡：
   - 技术约束（语言、存储、托管）
   - 明确的权衡或被拒绝的替代方案

   术语与一致性：
   - 规范化术语表
   - 避免的同义词 / 废弃术语

   完成信号：
   - 验收标准的可测试性
   - 可量化的完成定义指标

   杂项 / 占位符：
   - TODO 标记 / 未决事项
   - 模糊形容词（如 “robust”、“intuitive”）未量化

   对于状态为 Partial 或 Missing 的类别，应生成候选提问，除非：
   - 澄清不会实质改变实现或验证策略
   - 信息更适合在规划阶段处理（内部备注）

3. 内部生成按优先级排序的候选澄清问题队列（最多 5 个）。不要一次性全部输出。遵循以下限制：
    - 整个会话最多 10 个问题。
    - 每个问题必须满足以下其一：
       - 简短的多选题（2–5 个互斥选项），或
       - 一词 / 短语回答（明确限制：“回答不超过 5 个词”）。
    - 仅包含答案会实质影响架构、数据建模、任务分解、测试设计、UX 行为、运维就绪或合规验证的问题。
    - 保持类别覆盖平衡：优先解决影响最大的未解类别；避免在高影响领域（如安全态势）未解决时提出多个低影响问题。
    - 排除已回答的问题、琐碎的风格偏好、或规划层面的执行细节（除非影响正确性）。
    - 优先选择能降低后续返工风险或避免验收标准偏差的澄清。
    - 若未解决类别超过 5 个，按“影响 * 不确定性”启发式挑选前 5 个。

4. 交互式提问循环：
    - 每次仅呈现一个问题。
    - 对于多选题：
       - **分析所有选项**，并根据以下因素确定**最佳选项**：
          - 该项目类型的最佳实践
          - 类似实现中常见的模式
          - 风险降低（安全、性能、可维护性）
          - 与规格中明确的项目目标或约束是否一致
       - 将你的**推荐选项**置于顶部，并给出 1-2 句理由说明为何最优。
       - 格式：`**Recommended:** Option [X] - <reasoning>`
       - 随后使用 Markdown 表格列出全部选项：

       | Option | Description |
       |--------|-------------|
       | A | <Option A description> |
       | B | <Option B description> |
       | C | <Option C description>（如需可增至 D/E，最多 5 项）|
       | Short | 提供其他简短回答（≤5 个词）（仅在适合自由回答时添加）|

       - 表格后附加提示：`You can reply with the option letter (e.g., "A"), accept the recommendation by saying "yes" or "recommended", or provide your own short answer.`
    - 对于短答题（无有意义的离散选项）：
       - 根据最佳实践与上下文给出你的**建议答案**。
       - 格式：`**Suggested:** <your proposed answer> - <brief reasoning>`
       - 然后输出：`Format: Short answer (<=5 words). You can accept the suggestion by saying "yes" or "suggested", or provide your own answer.`
    - 用户回答后：
       - 若用户回复 "yes"、"recommended" 或 "suggested"，则采用你先前提供的推荐/建议作为答案。
       - 否则验证回答是否对应某个选项或符合 ≤5 个词的限制。
       - 若存在歧义，快速请求澄清（仍视为同一问题，不计新增）。
       - 确认无误后，将答案记录在工作记忆中（暂不写入磁盘），然后进入下一个问题。
    - 在以下情况停止提问：
       - 关键歧义已提前解决（剩余队列不再必要），或
       - 用户表示结束（“done”、“good”、“no more”），或
       - 已问满 5 个问题。
    - 切勿提前透露后续排队的问题。
    - 若一开始就没有有效问题，应立即报告不存在需要正式澄清的关键歧义。

5. 每次获得答案后立刻整合（增量更新）：
    - 保持规格的内存表示（启动时加载一次）与原始文件内容。
    - 本次会话的第一条澄清需：
       - 确认存在 `## Clarifications` 部分（若缺失，则按模板在最高层概述章节之后创建）。
       - 在其下创建 `### Session YYYY-MM-DD` 副标题（若尚未存在）。
    - 接受答案后立即追加条目：`- Q: <question> → A: <final answer>`。
    - 随后将澄清应用到最合适的章节：
       - 功能歧义 → 更新或新增功能需求中的条目。
       - 用户交互 / 角色区分 → 更新用户故事或角色子节，写明角色、约束或场景。
       - 数据结构 / 实体 → 更新数据模型（补充字段、类型、关系），保持原有顺序，并简洁记录新增约束。
       - 非功能约束 → 在非功能 / 质量属性章节中新增或修改可量化指标（把模糊词转为指标或明确目标）。
       - 边界情况 / 负向流程 → 在边界情况 / 错误处理下新增条目（或按模板创建该子节）。
       - 术语冲突 → 在规格中统一术语；必要时仅在首次出现处加注 `(formerly referred to as "X")`。
    - 若澄清推翻了早先的模糊描述，应直接替换原句，避免出现矛盾的重复内容。
    - 每次整合后立即保存规格文件（原子覆盖），降低上下文丢失风险。
    - 保持排版：不要重新排序无关章节，维持标题层级。
    - 添加的澄清应简洁、可验证，避免冗长叙述。

6. 校验（每次写入后执行，并在结束时再整体检查）：
   - 本次澄清会话中，每个已接受答案对应唯一的列表项（无重复）。
   - 总提问数（接受的）≤ 5。
   - 更新的章节中不应再留有该答案旨在解决的模糊占位。
   - 不得保留与新答案矛盾的旧描述（检查并移除已失效的备选语句）。
   - Markdown 结构必须有效；仅允许新增的标题：`## Clarifications`、`### Session YYYY-MM-DD`。
   - 术语需前后一致：所有更新章节使用同一规范用词。

7. 将更新后的规格写回 `FEATURE_SPEC`。

8. 输出完成报告（提问循环结束或提前终止时）：
   - 问答数量。
   - 更新后的规格路径。
   - 涉及的章节（列出名称）。
   - 覆盖率汇总表：列出每个分类及状态 —— Resolved（原为 Partial/Missing，已解决）、Deferred（超出问题配额或更适合规划阶段）、Clear（已充分）、Outstanding（仍为 Partial/Missing 但影响较低）。
   - 若仍有 Outstanding 或 Deferred，建议是否进入 `/speckit.plan`，或在规划后再运行 `/speckit.clarify`。
   - 建议的下一条命令。

行为准则：

- 若未发现实质性歧义（或所有潜在问题影响较低），回复：“No critical ambiguities detected worth formal clarification.” 并建议继续流程。
- 若规格文件缺失，提示用户先运行 `/speckit.specify`（本命令不创建新规格）。
- 总提问数不得超过 5（单个问题的重试不计追加）。
- 除非缺失会阻碍功能清晰度，否则避免对技术栈进行猜测性提问。
- 尊重用户的提前结束信号（“stop”、“done”、“proceed”）。
- 如因覆盖充分而无需提问，输出简要覆盖汇总（全部状态为 Clear），然后建议继续。
- 若问题配额已满仍有高影响类别未解，需在 Deferred 中明确标注原因。

优先级背景：$ARGUMENTS
