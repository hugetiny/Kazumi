# Kazumi Internationalization (i18n) Guide

## Overview

Kazumi uses [slang](https://pub.dev/packages/slang) for internationalization, integrated with [Riverpod](https://pub.dev/packages/riverpod) for state management. This architecture allows for:

- Type-safe translations
- Hot reload support during development
- Easy addition of new languages
- Integration with translation platforms like Weblate

## Architecture

### Components

1. **Translation Files** (`lib/l10n/*.i18n.json`)
   - JSON files containing translations for each locale
   - Named pattern: `app_<locale>.i18n.json` (e.g., `app_en-US.i18n.json`)
   - Base locale: `zh-CN` (Simplified Chinese)

2. **Generated Code** (`lib/l10n/generated/translations.g.dart`)
   - Auto-generated by slang
   - Provides type-safe access to translations
   - Regenerated when translation files change

3. **Locale Provider** (`lib/pages/setting/providers.dart`)
   - Manages app locale state using Riverpod
   - Persists user's language preference
   - Handles system locale fallback

4. **Configuration** (`slang.yaml`)
   - Defines slang behavior
   - Specifies input/output directories
   - Sets base locale and fallback strategy

## Supported Languages

Currently supported locales:

| Locale Code | Language | Status |
|-------------|----------|--------|
| zh-CN | Simplified Chinese | ✅ Base locale |
| en-US | English | ✅ Complete |
| ja-JP | Japanese | ✅ Complete |
| zh-TW | Traditional Chinese | ✅ Complete |

## Adding a New Language

### Step 1: Create Translation File

1. Copy the base translation file:
   ```bash
   cp lib/l10n/app_zh-CN.i18n.json lib/l10n/app_<new-locale>.i18n.json
   ```

2. Update the `@@locale` field:
   ```json
   {
     "@@locale": "your-locale-code",
     ...
   }
   ```

3. Translate all string values (keep keys in English)

### Step 2: Generate Code

Run the slang code generator:

```bash
flutter pub run slang
```

Or use build_runner:

```bash
flutter pub run build_runner build --delete-conflicting-outputs
```

### Step 3: Update Locale Options

Add the new locale to the language selector in `lib/pages/setting/setting_page.dart`:

```dart
final List<_AppLocaleOption> appLocaleOptions = [
  // ... existing options
  _AppLocaleOption(
    label: 'Your Language (locale-code)',
    locale: AppLocale.yourLocale,
  ),
];
```

### Step 4: Test

1. Build the app
2. Go to Settings > General > App Language
3. Select your new language
4. Verify all strings are displayed correctly

## Translation File Structure

### Basic Structure

```json
{
  "@@locale": "en-US",
  "category": {
    "subcategory": {
      "key": "Translation value"
    }
  }
}
```

### Using Placeholders

For dynamic content, use placeholders:

```json
{
  "metadata": {
    "lastSynced": "Last synced: {timestamp}"
  }
}
```

Usage in code:
```dart
Text(t.metadata.lastSynced(timestamp: formattedTime))
```

### Nested Objects

Organize translations hierarchically:

```json
{
  "settings": {
    "general": {
      "title": "General",
      "appearance": "Appearance"
    },
    "metadata": {
      "title": "Metadata",
      "enableBangumi": "Enable Bangumi"
    }
  }
}
```

## Usage in Code

### Method 1: Context Extension (Reactive)

Recommended for widgets that should rebuild on locale change:

```dart
Widget build(BuildContext context) {
  final t = context.t; // or AppTranslations.of(context)
  return Text(t.settings.title);
}
```

### Method 2: Riverpod Provider (Non-widget, Reactive)

When you need localized strings inside controllers, services, or utilities managed by Riverpod, read the shared provider:

```dart
import 'package:kazumi/providers/translations_provider.dart';

final translations = ref.read(translationsProvider);
final title = translations.settings.title;
```

### Method 3: Global Instance (Non-reactive)

For one-time translations where reactivity is not required:

```dart
import 'package:kazumi/l10n/generated/translations.g.dart';

final title = t.settings.title;
```

### Method 4: Direct Locale Access

For specific locale translations:

```dart
final chineseTitle = AppLocale.zhCn.translations.settings.title;
```

## Locale Management

### Setting Locale Programmatically

```dart
// Set specific locale
LocaleSettings.setLocale(AppLocale.enUs);

// Use device locale
LocaleSettings.useDeviceLocale();

// Get current locale
final current = LocaleSettings.currentLocale;
```

### Using Locale Provider (Recommended)

```dart
// In a ConsumerWidget
final localeState = ref.watch(localeSettingsProvider);
final localeController = ref.read(localeSettingsProvider.notifier);

// Set locale
await localeController.setLocale(AppLocale.jaJp);

// Use system locale
await localeController.useSystemLocale();
```

## Best Practices

### 1. Keep Keys Consistent

Always use English keys across all locales:

```json
// ✅ Good
{
  "@@locale": "ja-JP",
  "settings": { "title": "設定" }
}

// ❌ Bad
{
  "@@locale": "ja-JP",
  "設定": { "タイトル": "設定" }
}
```

### 2. Use Semantic Keys

Choose descriptive, hierarchical keys:

```json
// ✅ Good
{
  "settings": {
    "player": {
      "danmakuSettings": "Danmaku Settings"
    }
  }
}

// ❌ Bad
{
  "settings": {
    "text1": "Danmaku Settings"
  }
}
```

### 3. Handle Pluralization

Use slang's plural support:

```json
{
  "items": {
    "zero": "No items",
    "one": "1 item",
    "other": "{count} items"
  }
}
```

### 4. Context-Aware Translations

Provide context in key names:

```json
{
  "button": {
    "confirmDelete": "Delete",
    "confirmSave": "Save"
  }
}
```

### 5. Maintain Consistency

- Use consistent terminology across the app
- Follow the style guide in `.weblate`
- Keep tone and formality uniform

## Weblate Integration

### Setup

1. Fork the repository
2. Configure Weblate project with `.weblate` configuration
3. Connect your GitHub repository
4. Enable automatic pull requests

### Workflow

1. Translators work on Weblate platform
2. Weblate automatically commits translations
3. Weblate creates pull requests to main repo
4. CI validates translation files
5. Maintainers review and merge

### Quality Checks

Weblate performs automatic checks:
- Missing translations
- Inconsistent formatting
- Placeholder syntax errors
- Trailing/leading whitespace
- Punctuation consistency

## Development Workflow

### Adding New Strings

1. Add string to base locale (`app_zh-CN.i18n.json`)
2. Add corresponding translations to other locales (`app_en-US.i18n.json`, `app_ja-JP.i18n.json`, `app_zh-TW.i18n.json`)
3. Run `flutter pub run slang` to regenerate translations
4. Use the new translation in code via `t.category.key` or `ref.read(translationsProvider)`
5. Run `dart run tool/localization_audit.dart` to verify no hardcoded strings remain
6. Commit both the JSON files and generated `translations.g.dart`

### Localization Audit Tool

Kazumi includes an automated audit tool (`tool/localization_audit.dart`) that scans for hardcoded UI strings and translation inconsistencies:

**What it checks:**
- Hardcoded string literals in `Text()` widgets within scanned directories
- Hardcoded strings in `KazumiDialog.showToast()` calls
- Translation key parity between base locale and other locales

**Running the audit:**
```bash
# Direct execution
dart run tool/localization_audit.dart

# Via unit test
flutter test test/unit/localization_audit_test.dart
```

**CI Integration:**
The audit runs automatically in the `generate-translations` GitHub Actions workflow when translation files change. PRs with hardcoded strings will fail the check.

**Allowed exceptions:**
- Single punctuation marks (`-`, `…`, `·`)
- URLs (containing `://`)
- Purely symbolic strings without meaningful characters

**Fixing violations:**
1. Identify the file and line number from audit output
2. Extract the hardcoded string into a translation key
3. Add the key to all locale JSON files
4. Regenerate translations with `flutter pub run slang`
5. Replace the literal with `t.category.key`
6. Re-run audit to confirm fix

### Testing Translations

1. Change app language in settings
2. Navigate through the app
3. Verify all strings display correctly
4. Check for layout issues (text overflow, etc.)

### Hot Reload

Translations support hot reload during development:

1. Modify a translation file
2. Run `flutter pub run slang`
3. Hot reload the app (without full restart)

## Troubleshooting

### Translations Not Updating

1. Regenerate translations:
   ```bash
   flutter pub run slang
   ```

2. Clean and rebuild:
   ```bash
   flutter clean
   flutter pub get
   flutter run
   ```

### Missing Translations

- Check for typos in keys
- Ensure all locales have the same key structure
- Verify the locale file is in `lib/l10n/`

### Locale Not Available

1. Confirm locale is added to `AppLocale` enum
2. Check translation file naming convention
3. Regenerate with slang
4. Rebuild the app

### Tray Menu Shows Wrong Language or Crashes

- Desktop shell integrations (tray tooltip/menu) must avoid `BuildContext.t` because those callbacks run before `TranslationProvider` attaches to the widget tree.
- Use `KazumiTrayLabels.current()` from `lib/utils/tray_localization.dart` to obtain locale-aware strings in non-widget code.
- Ensure `AppWidget` listens to `localeSettingsProvider` so tray labels refresh when users change language at runtime.

## Contributing

### Translation Guidelines

1. **Accuracy**: Ensure translations are accurate and natural
2. **Context**: Consider UI constraints and context
3. **Consistency**: Follow existing terminology
4. **Testing**: Test translations in the app when possible

### Submitting Translations

#### Via Weblate (Recommended)
1. Register on Weblate
2. Select Kazumi project
3. Choose your language
4. Translate strings
5. Weblate will create PR automatically

#### Via GitHub
1. Fork the repository
2. Create a new branch
3. Add/update translation files
4. Test your translations
5. Submit a pull request

## Resources

- [slang Documentation](https://pub.dev/packages/slang)
- [Flutter Internationalization](https://docs.flutter.dev/development/accessibility-and-localization/internationalization)
- [Weblate Documentation](https://docs.weblate.org/)
- [Kazumi Repository](https://github.com/hugetiny/Kazumi)

## Support

For questions or issues:
- Open an issue on GitHub
- Join our community discussions
- Contact maintainers

---

**Note**: This architecture provides a solid foundation for continuous localization. As the app grows, translations should be updated alongside new features.
