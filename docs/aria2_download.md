# aria2 下载管理功能

## 概述

Kazumi 现已集成 aria2 下载管理功能，**自动管理 aria2 进程**，无需手动启动。支持桌面版（Windows、macOS、Linux）和 Android。

## 功能特性

### 自动 aria2 进程管理 ✨
- **自动启动**: 应用启动时自动运行 aria2
- **自动停止**: 应用退出时自动停止 aria2
- **进程监控**: 实时查看 aria2 运行状态
- **一键重启**: 支持在设置中重启 aria2
- **平台支持**: 桌面版和 Android（iOS 不支持子进程）

### 下载管理页面
- **位置**: 我的 → 下载管理
- **功能**:
  - 实时查看下载进度
  - 暂停/继续/删除下载任务
  - 查看下载速度和文件大小
  - 分类显示：下载中、已完成、全部
  - 自动刷新下载状态（2秒间隔）

### 视频播放器集成
- 播放器顶部工具栏下载按钮
- 更多菜单中的"下载视频"选项
- 自动提取视频标题和集数信息
- 一键添加到下载队列

### 下载设置
- **位置**: 设置 → 下载设置
- **配置项**:
  - aria2 端点地址（默认：http://127.0.0.1:6800/jsonrpc）
  - aria2 密钥配置
  - 请求超时时间（5-120秒）
  - 最大并发下载数
  - 连接测试功能
  - aria2 状态检查和重启

## 安装 aria2

**重要**: Kazumi 会自动启动 aria2，您只需要安装 aria2 到系统即可。

### Windows
1. 从 [aria2 releases](https://github.com/aria2/aria2/releases) 下载最新版本
2. 解压并将 `aria2c.exe` 所在目录添加到系统 PATH
3. 或解压到常用位置（如 `C:\Program Files\aria2\`）

### macOS
```bash
brew install aria2
```

### Linux
```bash
# Debian/Ubuntu
sudo apt install aria2

# RHEL/CentOS
sudo yum install aria2
```

### Android
通过 Termux 安装：
```bash
pkg install aria2
```

## 使用方法

### 首次使用

1. **安装 aria2**（参考上面的安装说明）

2. **启动 Kazumi**
   - Kazumi 会自动启动 aria2 进程
   - 无需手动运行 aria2 命令

3. **验证连接**（可选）
   - 进入"设置 → 下载设置"
   - 点击"检查"按钮查看 aria2 状态
   - 点击"测试"按钮验证连接

### 下载视频

有两种方式添加下载任务：

**方式1: 从播放器下载**
1. 播放任意视频
2. 点击播放器顶部的下载按钮，或
3. 点击更多菜单 (⋮) → "下载视频"

**方式2: 管理下载任务**
1. 进入"我的 → 下载管理"
2. 查看所有下载任务
3. 使用控制按钮管理下载

### 管理 aria2 进程

在"设置 → 下载设置 → 进程管理"中：
- **检查状态**: 查看 aria2 是否运行
- **重启 aria2**: 如遇问题可一键重启
- **自动管理**: 应用启动/退出时自动启动/停止

## 技术实现

- **架构**: 使用独立 aria2 进程通过 JSON-RPC 通信
- **进程管理**: 自动启动和停止 aria2 子进程
- **状态管理**: Riverpod StateNotifier
- **数据持久化**: Hive 数据库
- **自动同步**: 每2秒自动刷新下载状态
- **平台支持**: Windows、macOS、Linux、Android（iOS 不支持）

## 常见问题

### Q: 需要手动启动 aria2 吗？
A: 不需要。Kazumi 会在启动时自动运行 aria2，退出时自动停止。您只需要确保 aria2 已安装在系统中。

### Q: iOS 为什么不支持？
A: iOS 系统限制不允许应用运行子进程，因此无法自动启动 aria2。

### Q: 如何确认 aria2 正在运行？
A: 在"设置 → 下载设置 → 进程管理"中点击"检查"按钮查看状态。

### Q: aria2 找不到怎么办？
A: 确保 aria2 已正确安装：
- Windows: 将 aria2c.exe 所在目录添加到系统 PATH
- macOS/Linux: 使用包管理器安装会自动配置 PATH
- Android: 通过 Termux 安装

### Q: 为什么选择独立 aria2 而不是 libaria2？
A: 独立 aria2 进程具有以下优势：
- 更稳定和功能完整
- 独立更新维护
- Flutter 集成更简单
- 社区支持更好

### Q: 连接失败怎么办？
A: 检查以下项目：
1. 在设置中点击"检查"确认 aria2 是否运行
2. 如果未运行，点击"重启"按钮
3. 确认 aria2 已正确安装在系统中
4. 端点地址是否正确（默认通常无需修改）
5. 密钥配置是否正确

### Q: 应用重启后下载任务还在吗？
A: 是的，所有下载任务都会保存在本地数据库中。应用重启后，Kazumi 会自动启动 aria2 并恢复任务状态。

## 未来计划

- [ ] 支持磁力链接下载
- [ ] 支持 BT 种子下载
- [ ] 下载完成通知
- [ ] 下载队列优先级
- [ ] 自动重试失败任务
